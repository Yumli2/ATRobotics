#include <Servo.h>
#include "Smile.h"
//==========================================================
//Buzzer
#define BUZ 5 string
//==========================================================
//RGB
LED rgb(8, 7, 6); //Seta os pinos do Led RGB
//==========================================================
//PID construtor
PID meuPid1(10, 0.02, 0.05);
//PID meuPid2(3.2, 0.02, 0.05);
#define SetPoint 20 //Seta em 20 Cm
//==========================================================
//Ultrasson
ULTRA Ultrasson(10, 9); //Passa o Echo e o Trig
#define distLimitMax 400 //Define que a medidas maxima do sensor é de 4 metros
#define distLimitMin 2 //Define que a medidas minimas do sensor é de 2 centimetro
#define alcanceMin 40 //Define o alcance de ativação do Smile
#define filtroInter 5 //Esse primeiro é para filtrar ruidos dos sinais abaixo de 40 quando ele estiver parado sem nenhum obstaculo a ser detectado
#define filtroInter2 5 //Esse segunda filtra possiveis ruidos acima ou abaixo do intervalo de parada 1 e parada 2
#define parada1 25 //Primeiro intervalo de parada Maxima
#define parada2 20 //Segundo intervalo de parada Minima
double lastDist = 0, count = 0;//lastDist guarda a ultima leitura da distancia, count é a variavel utilizadas para contagem e obtencao da certeza de um objeto ou obstaculo.
//==========================================================
//Servo
Servo myservo1;
Servo myservo2;
double posCentral = 1468;//90;//direita parado e quando diminui  velocidade
double posCentral2 = 1436;//86;//esquerda parado e quando aumetar ele vai pra frente e aumentar a velocidade 86+45
double flag, flag2, disT = 0, disT2 = 0, PID = 0;

void setup() {
  Serial.begin(9600);
  meuPid1.setSetPoint(SetPoint);//Passa o offset/ponto de referencia
}
void loop() {
  flag = 1;
  if ( (disT = Ultrasson.distancia() < distLimitMax) && (disT > distLimitMin) ) {
    Serial.println(Ultrasson.distancia());
    while (disT = Ultrasson.distancia() < alcanceMin) {
      count++;//filtra possiveis interferencias de sinal do ultrasson quando o valor de alcance for menor que o previsto
      if (count > filtroInter) { //Se foi realizado as leituras foram feitas acima da quantidade count é pq realmente tem um objeto para realizar uma ação
        if (flag != 0) {
          myservo1.attach(12);//direito
          myservo2.attach(11);//esquerdo
        } flag = 0;//Muda o estado para os pinos do servo serem ativados apenas uma vez
        // Intervalo para desativar os pinos do servo
        if (disT <= parada1 && disT >= parada2) {
          count = 0;
          while ((disT <= parada1) && (disT >= parada2) ) {
            count++; lastDist = disT; //pra assegura que a leitura do sensor esta dentro do range de maximo 4 metros e filtrar possiveis ruidos
            Serial.println(Ultrasson.distancia());
            if (count > filtroInter2) {
              myservo1.detach();//direito
              myservo2.detach();//esquerdo
              flag = 1;//Sinaliza novamente a ativação dos pinos do servo
            }
            (disT = Ultrasson.distancia()) < distLimitMax && (disT > distLimitMin) ? disT = disT : disT = lastDist;//assegura uma boa leitura dos intervalos de parada
          }
        }
        //Manda as amostra de leitura da distancia para o objeto PID!
        meuPid1.addNewSample(disT);
        // Converte para controle
        PID = meuPid1.process();
        myservo1.writeMicroseconds(int(PID + posCentral));// Direita quanto menor maior velocidade
        myservo2.writeMicroseconds(int(abs(PID - posCentral2)));// Esquerda
        Serial.print(PID); Serial.print(" - "); Serial.print(int(PID + posCentral)); Serial.print(" - "); Serial.print(int(abs(PID - posCentral2))); Serial.print(" - "); Serial.print(disT);
      }
    }
  }
  //rgb.statusRed(0);
  //rgb.statusBlue(0);
  //rgb.statusGreen(0);
  myservo1.detach();//direito
  myservo2.detach();//esquerdo
  count = 0;
}

